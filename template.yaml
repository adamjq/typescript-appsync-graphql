AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: GraphQL Messages API using NodeJS and Typescript

Parameters:
  APIName:
    Type: String
    Description: The name of the GraphQL API
    MinLength: 3
    MaxLength: 20
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9_]*$'
    Default: MessagesGraphQLAPI

Globals:
  Function:
    Runtime: nodejs10.x
    Timeout: 10
    Environment:
      Variables:
        DYNAMODB_TABLE: !Ref DynamoDBTable

Resources:

  DynamoDBTable:
    Description: "NoSQL DB for Message System"
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${APIName}-ddb-table
      AttributeDefinitions:
        - AttributeName: deviceId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: N
      KeySchema:
        - AttributeName: deviceId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  AppSyncApi:
    Type: "AWS::AppSync::GraphQLApi"
    Description: "The GraphQL API for the Messages"
    Properties:
      AuthenticationType: "API_KEY"
      Name: !Sub ${APIName}

  AppSyncSchema:
    Type: "AWS::AppSync::GraphQLSchema"
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      DefinitionS3Location: ./schema.graphql

  AppSyncLambdaServiceRole:
    Type: AWS::IAM::Role
    Description: "An IAM Role to allow AWS AppSync to invoke lambda functions"
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - appsync.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AppSyncInvokeLambdaPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource:
                  - !GetAtt GetMessageLambdaFunction.Arn
                  - !GetAtt AllMessagesLambdaFunction.Arn
                  - !GetAtt StoreMessageLambdaFunction.Arn
                  - !GetAtt GetDeviceLambdaFunction.Arn

  # AppSync Lambdas

  GetMessageLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./handler.zip
      Handler: getMessage.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  AllMessagesLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./handler.zip
      Handler: allMessages.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  StoreMessageLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./handler.zip
      Handler: storeMessage.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  GetDeviceLambdaFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./handler.zip
      Handler: getDevice.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable

  # AppSync Data Sources

  GetMessageLambdaDataSource:
    Type: "AWS::AppSync::DataSource"
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: !Sub ${APIName}_GetMessageLambdaDataSource
      Description: "The AppSync Lambda Data Source for getting a message"
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetMessageLambdaFunction.Arn

  AllMessagesLambdaDataSource:
    Type: "AWS::AppSync::DataSource"
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: !Sub ${APIName}_AllMessagesLambdaDataSource
      Description: "The AppSync Lambda Data Source for getting all messages"
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt AllMessagesLambdaFunction.Arn

  StoreMessageLambdaDataSource:
    Type: "AWS::AppSync::DataSource"
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: !Sub ${APIName}_StoreMessageLambdaDataSource
      Description: "The AppSync Lambda Data Source for storing a message"
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt StoreMessageLambdaFunction.Arn

  GetDeviceLambdaDataSource:
    Type: "AWS::AppSync::DataSource"
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      Name: !Sub ${APIName}_GetDeviceLambdaDataSource
      Description: "The AppSync Lambda Data Source for getting a device"
      Type: AWS_LAMBDA
      ServiceRoleArn: !GetAtt AppSyncLambdaServiceRole.Arn
      LambdaConfig:
        LambdaFunctionArn: !GetAtt GetDeviceLambdaFunction.Arn

  # AppSync Resolvers

  GetMessageQueryResolver:
    Type: "AWS::AppSync::Resolver"
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getMessage
      DataSourceName: !GetAtt GetMessageLambdaDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $utils.toJson($ctx.args)
          }
        }
      ResponseMappingTemplate: "$util.toJson($context.result)"

  AllMessagesQueryResolver:
    Type: "AWS::AppSync::Resolver"
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: allMessages
      DataSourceName: !GetAtt AllMessagesLambdaDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $utils.toJson($ctx.args)
          }
        }
      ResponseMappingTemplate: "$utils.toJson($context.result)"

  StoreMessageMutationResolver:
    Type: "AWS::AppSync::Resolver"
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Mutation
      FieldName: storeMessage
      DataSourceName: !GetAtt StoreMessageLambdaDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $utils.toJson($ctx.args)
          }
        }
      ResponseMappingTemplate: "$utils.toJson($context.result)"

  GetDeviceQueryResolver:
    Type: "AWS::AppSync::Resolver"
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Query
      FieldName: getDevice
      DataSourceName: !GetAtt GetDeviceLambdaDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $utils.toJson($ctx.args)
          }
        }
      ResponseMappingTemplate: "$util.toJson($context.result)"

  GetDeviceMessagesResolver:
    Type: "AWS::AppSync::Resolver"
    DependsOn: AppSyncSchema
    Properties:
      ApiId: !GetAtt AppSyncApi.ApiId
      TypeName: Device
      FieldName: messages
      DataSourceName: !GetAtt AllMessagesLambdaDataSource.Name
      RequestMappingTemplate: |
        {
          "version": "2017-02-28",
          "operation": "Invoke",
          "payload": {
            "arguments": $utils.toJson($ctx.source)
          }
        }
      ResponseMappingTemplate: "$util.toJson($context.result)"

Outputs:

  DynamoDBTableName:
    Description: The name of the DynamoDB Table
    Value: !Ref DynamoDBTable

  GraphQLApiEndpoint:
    Description: The URL to the GraphQL Endpoint
    Value: !GetAtt AppSyncApi.GraphQLUrl

  GraphQLApiId:
    Description: The API ID of the GraphQL API
    Value: !GetAtt AppSyncApi.ApiId